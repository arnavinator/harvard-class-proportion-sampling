---
title: "ps_5"
author: "Arnav Srivastava"
date: "3/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# upload libraries to upload and process data and make gt table

library(tidyverse)
library(haven)
library(gt)

# upload dta data file 

dec <- read_dta("raw-data/ns20191226/ns20191226.dta")

```

## MadLibs

```{r madlibs, echo = FALSE}

# q1; find total respondents in gun_registry to see total who answered this
# question. In order to accomodate for the filter function not counting NA
# induviduals, who were asked the question but chose not to answer, I am
# explicitly retaining NA values when filtering alongside removing "888" (not
# asked) from gun_registry respondents to give the total number of people who
# were asked this question


q1 <- dec %>% 
  select(gun_registry) %>% 
  filter(is.na(gun_registry) |
           gun_registry != 888) %>% 
  summarize(sum(n()))


# q2; since all respondents were asked all 3 gun questions other than the
# registry question (as the codebook indicates the other questions do not have
# an "888" option), I filtered out the induviduals from the dataset who were
# "888" for gun_registry to get the number of people who answered all 4
# quesstions. Then since q1 is the total number of people asked questions, I
# filtered for all gun owners and divided this number by q1. I multiplied by 100
# and rounded to 2 decimal places to get the percent of all-respondents who are
# gun owners

gun_owners_asked <- dec %>% 
  filter(is.na(gun_registry) |
           gun_registry != 888) %>% 
  filter(household_gun_owner == 1) %>% 
  summarize(sum(n()))

percent_own <- (gun_owners_asked/q1)*100

q2 <- round(percent_own, 2)


# q3; drop respondents who weren't asked, didn't know, or skipped the question.
# Then filter for those who live in a household with guns, sum
# statements_gun_rights, and divide by total number of people who still fit
# criteria. Meanwhile, filter for those who do not live in a household with guns
# with similar processing. Finally, round each answer to 2 decimal places

gun_own_agree <- dec %>% 
  filter(household_gun_owner == 1 |
           household_gun_owner == 2) %>% 
  filter(statements_gun_rights != 888 &
           statements_gun_rights != 999) %>% 
  summarize(sum(statements_gun_rights)/sum(n())) %>% 
  pull(1)

gun_own_agree <- format(round(gun_own_agree, 2), nsmall = 2)


no_gun_agree <- dec %>% 
  filter(household_gun_owner == 3) %>% 
  filter(statements_gun_rights != 888 &
           statements_gun_rights != 999) %>% 
  summarize(sum(statements_gun_rights)/sum(n())) %>% 
  pull(1)

no_gun_agree <- format(round(no_gun_agree, 2), nsmall = 2)


# q4; filter within respective age groups, sort for top number of respondents,
# and then use haven_label labels (using as_factor) to extract the name of
# religion which is most followup per both subsets

religion_young <- dec %>% 
  filter(age %in% c(18,29)) %>% 
  count(religion) %>% 
  arrange(desc(n))

religion_y <- as_factor(religion_young, 
                        levels = c("labels"), 
                        ordered = FALSE) %>%  
  mutate(relig = as.character(religion)) %>% 
  slice(1) %>% 
  pull(relig)

 

religion_old <- dec %>% 
  filter(age >= 30) %>% 
  count(religion) %>% 
  arrange(desc(n)) 

religion_o <- as_factor(religion_old, 
                        levels = c("labels"), 
                        ordered = FALSE) %>% 
  mutate(relig = as.character(religion)) %>% 
  slice(1) %>% 
  pull(relig)


# q5; takes arranged list of religions popularity, and creates a rank col which
# ranks the popularity of religion per age group. Then, I select for the
# religion wanted to find its rank

young_rank <- as_factor(religion_young, 
                        levels = c("labels"), 
                        ordered = FALSE) %>% 
  mutate(rank = c(1:sum(n()))) %>% 
  filter(religion == "Nothing in particular") %>% 
  pull(rank)

old_rank <- as_factor(religion_old, 
                        levels = c("labels"), 
                        ordered = FALSE) %>% 
  mutate(rank = c(1:sum(n()))) %>% 
  filter(religion == "Nothing in particular") %>% 
  pull(rank)


# q6; filtering for the 888 option from statements_gun_rights, we find all of
# our relavent respondents. making a table grouping by religion and
# staements_gun_righs, we feed this table to as_factors to categorize
# statement_gun_rights and religion, and then select the most popular position
# from all the "nones"

religion <- dec %>% 
  filter(statements_gun_rights != 888) %>% 
  count(statements_gun_rights, religion)

nones <- as_factor(religion,
                   levels = c("labels"), 
                   ordered = FALSE) %>% 
  filter(religion == "Nothing in particular") %>% 
  arrange(desc(n)) %>% 
  mutate(position = as.character(statements_gun_rights)) %>% 
  slice(1) %>% 
  pull(position)

```

**1)** Not all respondents were asked every question. `r q1` respondents were asked the question about whether the USA should create a gun registry.

**2)**  Of the respondents that got asked all four gun policy questions, `r q2` percent are gun owners. 

**3)** The average “agreement” score (from 1-4) on the statement_gun_rights variable is `r no_gun_agree` for those respondents who live in households without guns, while the average “agreement” score in households with guns is `r gun_own_agree`.

**4)** Another set of questions asks about religion. The first ranked category of religion for the age group of people 18-30 is `r religion_y`. The first-ranked religion category for people 30 and older is `r religion_o`. 

**5)** Lots of people say that the younger generation has the highest percent of “nones;” people who answer “nothing in particular”, when you ask them their religion. In the 18-30 age group, “nothing in particular” is ranked `r young_rank`, while in the 30 and above group, “nothing in particular” is ranked `r old_rank`.

**6)** Consider again the nones (all people who responded “nothing in particular”) when asked about their religion. In this group, the most popular position is to `r nones` that it is more important for the government to control who owns guns than it is for the government to protect the right to own guns. 

## Question 2: Simulations with List Columns

```{r q2, echo = FALSE}
# 2a; makes a draw cards function which can only take numeric and have
# replacement when drawing cards

draw_cards <- function(n) {
   if(!is.numeric(n)) {
    stop('I am so sorry, but this function only works for numeric input!\n',
         'You have provided an object of class: ', class(n)[1])
  }
  sample(x = c("diamonds", "hearts", "spades", "clubs"), 
         size = n,
         replace = TRUE)
}


# 2b; makes a table of 2 cards being drawn 10 times using map

card_table <- tibble(cards = map(1:10, ~ draw_cards(2)))



# 2c; make a new column which checks for hearts or diamonds in the first and
# second col to accordingly mark if the card drawn is red or not.


card_table <- card_table %>% 
  mutate(check_red = map_lgl(map_chr(card_table$cards, 1),
                               ~ ifelse(. %in% c("hearts", "diamonds"), 
                                        TRUE, 
                                        FALSE)
                               ),
         check_red_2 = map_lgl(map_chr(card_table$cards, 2),
                               ~ ifelse(. %in% c("hearts", "diamonds"), 
                                        TRUE, 
                                        FALSE)
                               )
  )

# we then combine both check_red cols to a matrix, which we turn into a list
# where each item of the list tells if a set of cards are both red, both black,
# or mixed. I convert this list to characters so that we can check if each row
# for sets of cards drawn are (TRUE, TRUE), (FALSE, FALSE), or neither, which
# can identify if cards are both red, both black, or mixed respectively. Now
# that I have a string which describes each pair of cards, I use function
# color_outcome (which is compatabile with map function) so that we can see if
# each pair's description

color_outcome <- function (x) {
  if (all(x == "c(TRUE, TRUE)")) {
    "Both red"
  } else if (all(x == "c(FALSE, FALSE)")) {
      "Both black"
  } else {
      "Mixed"
  }
}

ll <- matrix(c(card_table$check_red, card_table$check_red_2), nrow = 10, byrow = FALSE)
ll <- t(ll)
bb <- split(ll, rep(1:ncol(ll), each = nrow(ll)))
bb <- as.character(bb)

card_table <- card_table %>% 
  mutate(check_combined = map_chr(bb, color_outcome)
  )


# finally, we format our complete table to a gt table, and print it

card_table %>% 
  gt(auto_align = TRUE) %>% 
  tab_header(title = "Drawing Two Cards",
             subtitle = "Card Colors") %>%
  cols_label(cards = "Draw",
             check_red = "First card red?",
             check_red_2 = "Second card red?",
             check_combined = "Color Outcome"
             )


```





Collaborators: None. Check for titles!!!!

